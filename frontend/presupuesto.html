<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Presupuestos MG Placas</title>
  </head>
  <body>
    <div class="container">
        <div class="page-header text-center">
            <h1>Presupuesto MG Placas y Placares</h1>
            <hr>
        </div>
        <form id="frmPresupuesto" method="POST">
            <div class="row">
                <div class="col-md-12">
                    <div id="pnlError" class="alert alert-danger" role="alert" style="display:none">
                        Revise los datos ingresados!
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label for="exampleInputEmail1">Email cliente</label>
                        <input type="email" class="form-control" id="txtMail" aria-describedby="emailHelp" placeholder="email cliente">
                        <small id="emailHelp" class="form-text text-muted">Ingrese el mail del cliente.</small>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label>Presupuesto</label>
                </div>
            </div>
            <div class="row entradas">
                <div class="form-group col-md-6">
                    <input type="text" class="form-control" name="prod" id="txtProducto" placeholder="Producto">
                </div>
                <div class="form-group col-md-2">
                    <input type="text" class="form-control validarNum" name="cant" id="txtCant" placeholder="Cant">
                </div>
                <div class="form-group col-md-2">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon-unitario">$</span>
                        </div>
                        <input type="text" class="form-control validarNum" name="unit" id="txtUnitario" placeholder="Unitario" aria-label="Total" aria-describedby="basic-addon-unitario">
                    </div>
                </div>
                <div class="form-group col-md-2 ult">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">$</span>
                        </div>
                        <input type="text" class="form-control" name="total" id="txtTotal" placeholder="Total" aria-label="Total" aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>
            <button id="btnAgregar" type="button" class="btn btn-secondary"><strong>+</strong></button>
            <button id="btnEliminar" type="button" class="btn btn-secondary"><strong>-</strong></button>
            <button id="btnEnviar" type="button" class="btn btn-primary float-right">Enviar</button>
            </form>
    </div>

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    
    <script type="text/javascript" src="js/validaciones.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            
            function nuevaLinea(i){
                var dom = `<div class="row entradas">
                <div class="form-group col-md-6">
                    <input type="text" class="form-control" name="prod${i}" id="txtProducto" placeholder="Producto">
                </div>
                <div class="form-group col-md-2">
                    <input type="text" class="form-control validarNum" name="cant${i}" id="txtCant" placeholder="Cant">
                </div>
                <div class="form-group col-md-2">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon-unitario">$</span>
                        </div>
                        <input type="text" class="form-control validarNum" name="unit${i}" id="txtUnitario" placeholder="Unitario" aria-label="Total" aria-describedby="basic-addon-unitario">
                    </div>
                </div>
                <div class="form-group col-md-2">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text" id="basic-addon1">$</span>
                        </div>
                        <input type="text" class="form-control" name="total${i}" id="txtTotal" placeholder="Total" aria-label="Total" aria-describedby="basic-addon1" readonly>
                    </div>
                </div>
            </div>`

            return dom
            }

            var i = 0
            
            //INICIAR CONTROLES
            $("#btnEliminar").attr("disabled", true)
            $("#btnEnviar").attr("disabled", true)

            //VALIDACIONES

            $("div").on('keyup', 'input', function(){
                validar()
            })

            function validar(){
                $("input").each(function( i, element ){
                    var valor = $(element).val()
                    if(valor == ""){
                        $(element).addClass("is-invalid")
                        $(element).removeClass("is-valid")
                    }else if($(element).hasClass('validarNum') && isNaN(valor)){
                        $(element).addClass("is-invalid")
                        $(element).removeClass("is-valid")
                    }else{
                        $(element).addClass("is-valid")
                        $(element).removeClass("is-invalid")
                        }
                })

                if($(".is-invalid").length == 0){
                    $("#btnEnviar").attr("disabled", false)
                }else{
                    $("#btnEnviar").attr("disabled", true)
                }
            }

            $("div").on('keyup', '.validarNum', function(){
                var parDiv = $(this).parents(".row")
                var cant = parDiv.find("[id^=txtCant]").val()
                var precio = parDiv.find("[id^=txtUnitario]").val()

                if (!isNaN(cant) && !isNaN(precio) && cant != "" && precio != ""){
                    parDiv.find("[id^=txtTotal]").val(precio * cant)
                }
            })

            $("#btnAgregar").click(function(){
                i++
                dom = nuevaLinea(i)
                $(".row:last").after(dom)
                $("#btnEliminar").attr("disabled", false)
                validar()
            }) 

            $("#btnEliminar").click(function(){
                
                if (i>0){
                    $(".row:last").remove()
                    i--
                }
                if(i==0){
                    $("#btnEliminar").attr("disabled", true)
                }
                validar()
            })   

            $("#btnEnviar").click(function(e) {
                e.preventDefault()
                var URL = "https://8slcpf2nkc.execute-api.us-east-1.amazonaws.com/prod/v1/presupuesto"

                var items =[]
                console.log($(".entradas").length)
                $(".entradas").each(function( i, element ){
                    
                    var cant = $(element).find("[id^=txtCant]").val()
                    var unit = $(element).find("[id^=txtUnitario]").val()
                    var prod = $(element).find("[id^=txtProducto]").val()
                    var tot = $(element).find("[id^=txtTotal]").val()

                    var presupuesto = {
                    producto : prod,
                    cantidad : cant,
                    unitario : unit,
                    total : tot
                    }
                    items.push(presupuesto)
                })

                var data = {
                    mail: $("#txtMail").val(),
                    presupuestos : items
                }

                console.log(JSON.stringify(data))

                $.ajax({
                    type: "POST",
                    url : URL,
                    headers: {  'Access-Control-Allow-Origin': '*'},
                    dataType: "json",
                    crossDomain: "true",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(data),

                    
                    success: function () {
                    // clear form and show a success message
                    alert("Successfull");
                    $("#frmPresupuesto").reset();
                    location.reload();
                        },
                        error: function () {
                        // show an error message
                        alert("UnSuccessfull");
                        }});
                    })        
                })
    </script>
  </body>
</html>